# 카프카 프로듀서 옵션들
> Java library 기준 프로듀서의 필수&선택 옵션들

<br>

## 프로듀서 필수 옵션
> 설정된 default 값이 없는 옵션들을 말한다.

- bootstrap.servers: 프로듀서가 데이터를 전송할 대상 카프카 클러스터에 속한 브로커들의 호스트이름: 포트를 1개 이상 작성한다. 2개 이상을 입력하여 일부 브로커에 이슈가 발생하더라도 접속에 이슈가 없도록 설정할 수 있다. 
- key.serializer: 레코드의 메시지 키를 직렬화하는 클래스를 지정한다.
- value.serializer: 레코드의 메시지 값을 직렬화하는 클래스를 지정한다. 

### key, value 를 String 으로 직렬화하지 않을 때 문제점
1. kafka-console-consumer 에서 데이터를 디버깅하거나 확인할 수 없다.
2. topic 에 들어간 데이터가 어떻게 직렬화되어있는 지 모르기 때문에 역직렬화하는 방법을 알 수 없다. 

<br>

## 프로듀서 선택 옵션
> 설정된 default 값이 있는 옵션들을 말한다.

- acks (★) : 프로듀서가 전송한 데이터가 브로커들에 정상적으로 저장되었는지 전송 성공 여부를 확인하는 데에 사용한다. 0, 1, -1 중 하나로 설정할 수 있으며 default 값은 1 (성공) 이다.
- linger.ms : Accumulator 배치를 전송하기 전까지 기다리는 최소 시간, default 값은 0 이다.
- retries: 브로커로부터 에러를 받고 난 뒤 재전송을 시도하는 횟수를 지정, default 값은 2147483647 이다.
- max.in.flight.requests.per.connection: Sender 가 한 번에 요청하는 최대 커넥션 개수로 설정된 값만큼 동시에 전달 요청을 수행, default 값은 5 이다.
- partitioner.class : 레코드를 파티션에 전송할 때 적용하는 파티셔너 클래스를 지정, 기본 값은 org.apache.kafka.clients.producer.internals.DefaultPartitioner 인데, 2.5.0 부터는 UniformStickyPartitioner 로 지정된다. 
- enable.idempotence : 멱등성 프로듀서로 동작할 지 여부를 설정, 2.5.0 에서 default 값은 false 인데 3.x 부터는 true 이다. 
- transactional.id : 프로듀서가 레코드를 전송할 때 레코드를 트랜잭션 단위로 묶을 지 여부를 설정, default 값은 null 이다. 

<br>

## Acks 옵션과 ISR ( In-Sync-Recplicas )
### ISR ( In-Sync-Recplicas )
- 리더 파티션과 팔로워 파티션의 오프셋이 동일할 때 싱크가 되었다고 보며, 이를 ISR ( 싱크가 된 상태 ) 라고 한다. 
- 동기화가 완료되었다는 의미는 리더 파티션의 모든 데이터가 팔로워 파티션에 복제된 상태를 말한다. → 안전하게 Failover 가능
- 팔로워 파티션이 리더 파티션으로부터 데이터를 복제하는 데에 시간이 걸리고, 프로듀서로부터 리더 파티션에 새로운 레코드가 추가되어 오프셋이 증가한다. 즉, 리더 파티션에 데이터가 적재된 이후 팔로워 파티션이 복제하는 **시간차가 발생**하여 오프셋 차이가 발생하게 된다.

### Acks 옵션
- 0, 1, all(또는 -1) 중 하나의 값을 갖는다. 
- 이 옵션을 통해 프로듀서가 전송한 데이터가 카프카 클러스터에 **얼마나 신뢰성 있게 저장할 것인지 선택**할 수 있다. 
- 옵션에 따라 성능이 달라지기 때문에 성능과 신뢰성 중 무엇을 더 중요시 할 것인가에 대해 고민하여 acks 옵션을 선택한다. 
- ISR 형태일 때 가장 신뢰도가 높다고 볼 수 있고, 차이가 날수록 신뢰도가 낮아진다.
- 복제 개수가 1인 경우 acks 옵션에 따른 성능 변화가 크지 않지만 안정적인 운영을 위해서는 복제 개수가 2 이상으로 운영하는 경우가 대부분이기 때문에 각 acks 별 동작 방식을 이해해야 한다. 

#### 1. acks = 0 ( 속도/처리량 ↑, 신뢰도 ↓ )
- 프로듀서가 리더 파티션으로 데이터를 전송했을 때 리더 파티션으로 데이터가 저장되었는 지 확인하지 않는다. → **데이터 유실 확인 X**, send() 호출만 확인
- 프로듀서는 리더 파티션에 데이터가 저장되었는지 여부에 대한 응답 값을 받지 않는다. 
- GPS 등의 속도가 중요한 지표 데이터인 경우 설정한다. 

#### 2. acks = 1 ( 0 에 비해 속도/처리량 ↓,  신뢰도 ↑ )
- 프로듀서가 보낸 데이터가 **리더 파티션에** 정상적으로 적재되었는 지 ( = 디스크에 저장 ) 확인한다. 
- 리더 파티션에 정상적으로 적재되지 않았다면 적재될 때까지 재시도 할 수 있다.
- 리더 파티션에 적재되었음을 보장하더라도 복제 개수를 2 이상으로 운영할 경우 팔로워 파티션에 데이터가 동기화되지 않았을 때 ( 데이터를 복제하기 전 ) 리더 파티션이 있는 브로커에 장애가 발생하면 데이터가 유실될 수 있다.
- 일반적인 경우로, 대부분 이 옵션을 사용한다. ( default )

#### 3. acks  = -1 (all) ( 속도/처리량 ↓,  신뢰도 ↑ )
- 프로듀서는 보낸 데이터가 **리더 파티션과 팔로워 파티션에 모두** 정상적으로 적재되었는 지 확인한다. 
- 팔로워 파티션까지 데이터를 확인하기 때문에 다른 옵션들에 비해 속도가 느리다.
- 일부 브로커에 장애가 발생하더라도 프로듀서는 안전하게 데이터를 전송하고 저장할 수 있음을 보장할 수 있다. 
- 토픽 단위로 설정 가능한 **min.insync.replicas** 옵션 값 ( 리더 파티션을 포함한 확인하는 파티션 개수 ) 에 따라 데이터의 안정성이 달라진다.

> **※ min.insync.replicas**
> - 프로듀서가 리더 파티션과 팔로워 파티션에 데이터가 적재되었는 지 확인하기 위한 최소 ISR 그룹의 파티션 개수
> - .replicas 옵션을 1 로 설정한다면 ISR 중 최소 1 개 이상의 파티션에 데이터가 적재되었음을 확인하고 이는 리더 파티션이 될 것이므로 acks 를 1 로 했을 때와 동일한 동작을 한다.
> - .replicas 옵션을 **2 로 설정했을 때부터** acks 를 -1(all) 로 설정하는 것에 의미가 있다. 이 경우 적어도 리더 파티션과 1개의 팔로워 파티션에 데이터가 정상적으로 적재되었음을 보장한다. 
> - 브로커가 동시에 2개 중단되는 일은 극히 드물기 때문에 2 로만 설정해도 데이터는 유실되지 않는다고 볼 수 있다. 

<br>

## 참고
[아파치 카프카 애플리케이션 프로그래밍](https://inf.run/uCwV5)