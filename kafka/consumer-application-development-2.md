# 카프카 컨슈머 애플리케이션 개발 2
> 카프카 기본 모델, 멀티스레드 컨슈머, 컨슈머 랙, 컨슈머 랙 모니터링 방법, 카프카 버로우(Burrow) <br>
> ( kafka-clients:2.5.0 라이브러리 기준 )

<br> 

## 카프카 기본 모델
- 카프카 기본 구조 : 1thread → 1consumer 모델이 사용된다. ( 각 컨슈머는 하나의 스레드에서 동작 )
- 처리량 증대 : 파티션 수를 늘리고 여러 컨슈머를 함께 운영하는 것이 일반적이며 각 파티션은 하나의 컨슈머에 할당되어 데이터를 처리한다.
- 최적의 성능을 위해 파티션의 개수와 컨슈머의 개수를 동일하게 맞추는 것이 이상적이다. 
- 파티션 수가 n 개라면, 동일한 컨슈머 그룹에 속한 최대 n 개의 컨슈머 스레드가 병렬로 데이터를 처리할 수 있다. 

<br> 

## 멀티스레드 컨슈머
1. n개의 스레드를 가진 하나의 프로세스를 운영한다. 하나의 프로세스 내에서 여러 스레드를 생성하여 각 스레드가 개별 파티션을 처리한다. 
2. n개의 단일 스레드 프로세스를 각각 운영한다. n 개의 프로세스가 각각 하나의 스레드를 가지고 각 프로세스가 하나의 파티션을 처리한다. 

<br> 

## 컨슈머 랙(LAG)
- 컨슈머 랙은 파티션의 최신 오프셋(LOG-END-OFFSET)과 컨슈머 오프셋(CURRENT-OFFSET) 간의 차이를 말한다. ( ex> 4-2 = 2 )
- 프로듀서는 계속해서 새로운 데이터를 파티션에 저장하고 컨슈머는 자신이 처리할 수 있는 만큼 데이터를 가져간다. 
- 컨슈머 랙은 컨슈머가 정상 동작하는지 여부를 확인할 수 있기 때문에 컨슈머 애플리케이션을 운영할 때 필수적으로 모니터링 해야 한다.
- 컨슈머 랙은 컨슈머 그룹과 토픽, 파티션 별로 생성된다. 예를 들어 1개의 토픽에 3개의 파티션이 있고 1개의 컨슈머 그룹이 토픽을 구독하여 데이터를 가져가면 컨슈머 랙은 3개가 되고, 컨슈머 그룹이 2개가 된다면 컨슈머 랙은 6개가 된다. 
- 프로듀서가 보내는 데이터양이 컨슈머의 데이터 처리량보다 크다면 컨슈머 랙은 늘어난다. 
- 프로듀서가 보내는 데이터양이 컨슈머의 데이터 처리량보다 작다면 컨슈머 랙은 줄어들고 최솟값은 0으로 지연이 없음을 뜻한다.
### 컨슈머 랙 모니터링 (★)
- 컨슈머의 장애를 확인할 수 있고 파티션 개수를 정하는 데에 참고할 수 있다. 
- 예를 들어 데이터 사용량이 많을 때 최대 처리량은 한정되어 있기 때문에 컨슈머 랙이 발생할 수 있다. 이러한 경우에는 지연을 줄이기 위해 일시적으로 파티션 개수와 컨슈머 개수를 늘려서 병렬처리량을 늘리는 방법을 사용할 수 있다. → 데이터 처리량 ↑
- 프로듀서의 데이터양이 일정함에도 불구하고 컨슈머의 장애로 인해 컨슈머 랙이 증가할 수도 있다. ( 파티션 이슈 )

<br> 

## 컨슈머 랙 모니터링 방법
### 1. 카프카 명령어 사용
- `kafka-consumer-groups.sh` 를 사용하면 컨슈머 랙을 포함한 특정 커슈머 그룹의 상태를 확인할 수 있다. 
- 이 방법은 일회성에 그치고 지표를 지속적으로 기록하고 모니터링하기에는 부족하다. 
- 그렇기 때문에 `kafka-consumer-groups.sh` 를 통해 컨슈머 랙을 확인하는 것은 테스트용 카프카에서 주로 사용한다. 
```powershell
> .\bin\windows\kafka-consumer-groups.bat --bootstrap-server my-kafka:9092 --group my-group --describe
```
### 2. metrics() 메서드 사용
- 컨슈머 인스턴스가 제공하는 컨슈머 랙 관련 모니터링 지표는 3가지로 records-lag-max, records-lag, records-lag-avg 이다.
#### metrics() 메서드 사용 이슈
- 컨슈머가 정상 동작할 경우에만 확인할 수 있기 때문에 컨슈머 애플리케이션이 비정상적으로 종료되면 더는 컨슈머 랙을 모니터링 할 수 없다. 
- 모든 컨슈머 애플리케이션에 컨슈머 랙 모니터링 코드를 중복해서 작성해야 한다. 왜냐하면 특정 컨슈머 그룹에 해당하는 애플리케이션이 수집하는 컨슈머 랙은 자기 자신 컨슈머 그룹에 대한 컨슈머 랙에 한정되기 때문이다. 
- 컨슈머 랙을 모니터링하는 코드를 추가할 수 없는 카프카 서드 파티(third party) 애플리케이션의 컨슈머 랙 모니터링이 불가능하다. 
### 3. 외부 모니터링 툴 사용
- 데이터 독(Datadog), 컨플루언트 컨트롤 센터(Confluent Control Center) 와 같은 카프카 클러스터 종합 모니터링 툴을 사용하면 카프카 운영에 필요한 다양한 지표를 모니터링할 수 있다. 
- 컨슈머 랙 모니터링만을 위한 툴로 오픈소스로 공개되어 있는 버로우(Burrow)가 있다. 

<br> 

## 카프카 버로우
- 버로우는 링크드인에서 개발하여 오픈소스로 공개한 **컨슈머 랙 체크 툴**로서 REST API 를 통해 컨슈머 그룹별로 컨슈머 랙을 확인할 수 있다. 
- 버로우는 다수의 카프카 클러스터를 동시에 연결하여 컨슈머 랙을 확인한다. 
- 기업 환경에서는 카프카 클러스터를 2개 이상으로 구축하고 운영하는 경우가 많기 때문에 한 번의 설정으로 다수의 카프카 클러스터 컨슈머 랙을 확인할 수 있다는 장점이 있다.
- REST API endpoint 확인하기 ( [참고](https://github.com/linkedin/Burrow/wiki/HTTP-Endpoint) )

> ※ 다른 외부 모니터링 툴을 사용 시 
> 카프카 클러스터에 연결된 모든 컨슈머, 토픽들의 랙 정보를 한번에 모니터링 할 수 있고 프로듀서나 컨슈머의 동작에 영향을 미치지 않는다는 장점이 있다. 

### 컨슈머 랙 이슈 판별
- 컨슈머와 파티션의 상태를 단순히 컨슈머 랙의 임계치(threshhold) 로 나타내지 않았다는 점이다.
- 특정 파티션의 컨슈머 랙이 특정 시점에 100만이 넘었다고 컨슈머 또는 파티션에 이슈가 있다고 단정 지을 수 없다. 프로듀서가 데이터를 많이 보내면 일시적으로 임계치가 넘어가는 현상이 발생할 수도 있기 때문이다. 
- 컨슈머 애플리케이션을 운영할 때 컨슈머 랙이 임계치에 도달할 때마다 알람을 받는 것은 무의미한 일이다.
### 컨슈머 랙 평가(Evaluation)
- 임계치가 아닌 슬라이딩 윈도우(sliding window) 계산을 통해 문제가 생긴 파티션과 컨슈머의 상태를 표현한다. 
- 이렇게 컨슈머 랙의 상태를 표현하는 것을 컨슈머 랙 평가(evaluation) 라고 부르며, 컨슈머 랙과 파티션의 오프셋을 슬라이딩 윈도우로 계산하면 상태가 정해진다.
- 결과적으로 파티션의 상태를 OK, STALLED, STOPPED 로 표현하고 컨슈머의 상태를 OK, WARNING, ERROR 로 표현한다. 
1. 정상적인 경우 ( 파티션 OK, 컨슈머 OK ) : 프로듀서가 지속적으로 데이터를 추가하여 최신 오프셋은 증가하고, 컨슈머는 데이터 처리를 하며 때때로 컨슈머 랙이 증가하지만 0으로 줄어드는 추이
2. 컨슈머 처리량 이슈 ( 파티션 OK, 컨슈머 WARNING ) : 프로듀서가 추가하는 최신 오프셋에 비해 컨슈머 오프셋이 따라가지 못하는 추이, 최신 오프셋과 컨슈머 오프셋의 거리가 계속 벌어지면서 컨슈머 랙은 지속적으로 증가한다. → 파티션과 컨슈머의 개수를 늘려 해결 가능.
3. 컨슈머 이슈 ( 파티션 STALLED, 컨슈머 ERROR ) : 최신 오프셋은 지속적으로 증가하지만 컨슈 오프셋이 멈춰 컨슈머 랙이 급격하게 증가하는 추이, 컨슈머 상태가 ERROR 인 경우에는 컨슈머가 확실히 비정상 동작하고 있으므로 이메일, SMS, 슬랙 등의 알람을 받고 즉각 조치해야 한다. 

<br>

## 컨슈머 랙 모니터링 아키텍처 ( [참고](https://github.com/AndersonChoi/kafka-lag-dashboard) )
> 카프카 클러스터 #0, #1, .. → 카프카 버로우 - 텔레그래프 → 엘라스틱서치 ← 그라파나 ← 컨슈머 랙 그래프 조회

: 컨슈머 랙 모니터링을 위해 사용할 수 있는 저장소와 대시보드 중 빠르고 무료로 설치할 수 있는 툴들은 다음과 같다. ( [설치방법](blog.voidmainvoid.net/279) )
- 버로우 : github.com/linkedin/Burrow
- 텔레그래프 : github.com/influxdata/telegraf
- 엘라스틱서치 : www.elastic.co/kr
- 그라파나 : grafana.com

<br>

## 참고
[아파치 카프카 애플리케이션 프로그래밍](https://inf.run/uCwV5)