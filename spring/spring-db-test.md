# (spring) 테스트 데이터 롤백과 임베디드 모드
> 테스트 - 데이터 롤백, 테스트 - @Transactional, 테스트 - 임베디드 모드 DB & 스프링 부트와 임베디드 모드

<br>

> ※ 테스트 원칙
> 1. 테스트는 다른 테스트와 격리해야 한다. 
> 2. 테스트는 반복해서 실행할 수 있어야 한다. 

## 테스트 - 데이터 롤백
- 테스트가 끝나고 이전 데이터의 잔여로 인해 테스트가 올바르게 수행되지 않는 문제점을 롤백 전략을 통해 해결할 수 있다. 
- 테스트가 끝나고 트랜잭션을 강제로 롤백하면 데이터가 깔끔하게 제거되어 원래 상태로 되돌릴 수 있다. 
- 각 테스트 실행 전 후로 동작하는 `@BeforeEach` 와 `@AfterEach` 를 활용한다.
```console
1. 트랜잭션 시작
2. 테스트 A 실행
3. 트랜잭션 롤백

4. 트랜잭션 시작
5. 테스트 B 실행
6. 트랜잭션 롤백
```

### 테스트에 직접 트랜잭션 추가
- 트랜잭션 관리자는 `PlatformTransactionManager` 를 주입받아 사용하면 된다.
- `transactionManager` 를 통해 테스트 수행 전 후로 트랜잭션을 시작하고 롤백한다. 
```java
@Slf4j
@SpringBootTest  
class ItemRepositoryTest {  
  
    @Autowired  
    ItemRepository itemRepository;  
  
    @Autowired
    PlatformTransactionManager transactionManager;
    TransactionStatus status;
    
    @BeforeEach    
    void beforeEach() {
	    // 테스트 실행 전에 트랜잭션 시작  
	    status = transactionManager.getTransaction(new DefaultTransactionDefinition());
	}
  
    @AfterEach  
    void afterEach() {  
		// 테스트 실행 후에 트랜잭션 롤백  
        transactionManager.rollback(status);  
    }
    
    // 테스트 A, B, ..
}
```

<br>

## 테스트 - @Transactional
- 이전에 트랜잭션 매니저를 통해 트랜잭션을 적용하고 롤백하는 코드를 제거하고 `@Transactional` 애노테이션 하나로 해결할 수 있다.
- 스프링이 제공하는 `@Transactional` 은 로직이 성공적으로 수행되면 커밋하도록 동작하는데 테스트에서 사용하게 되면 **스프링은 테스트를 트랜잭션 안에서 실행하고 테스트가 끝나면 트랜잭션을 자동으로 롤백**시킨다.
- 테스트 케이스의 메서드나 클래스에 붙여 사용할 때만 이렇게 동작한다.
- 트랜잭션을 테스트에서 시작하기 때문에 서비스, 리포지토리에 있는 `@Transactional` 은 트랜잭션이 그대로 이어진다. → 같은 범위 & 같은 트랜잭션 & 같은 커넥션

### @Transactional 적용
```java
@Slf4j  
@Transactional // ★ 추가
@SpringBootTest  
class ItemRepositoryTest {  
  
    @Autowired  
    ItemRepository itemRepository;
    
    // 테스트 A, B, ..
}
```

### 강제로 커밋하기 
- 테스트 과정에서 저장한 데이터를 보고싶을 때는 강제로 커밋하여 데이터를 확인할 수 있다. 
- `@Commit` 또는 `@Rollback(value = false)` 를 클래스나 메서드에 붙여 롤백 대신 커밋이 호출되도록 한다.
```java
@Transactional  
@Commit  
//@Rollback(value = false)  
@SpringBootTest  
class ItemRepositoryTest { .. }
```

### 정리
- 테스트가 끝난 후 개발자가 직접 데이터를 삭제하지 않아도 되어 편리하다.
- 테스트 실행 중 데이터를 등록하고 중간에 테스트가 강제로 종료되어도 트랜잭션을 커밋하지 않기 때문에 데이터는 자동으로 롤백된다. 
- 트랜잭션 범위 안에서 테스트를 진행하기 때문에 동시에 다른 테스트가 진행되어도 서로 영향을 주지 않는다. 
- 테스트 원칙을 편리하게 지킬 수 있다. 


<br>

## 테스트 - 임베디드 모드 DB & 스프링 부트와 임베디드 모드
> 테스트 케이스를 실행하기 위해 별도 데이터베이스를 설치하고 운영하는 것은 번거롭고 테스트를 검증할 용도로만 사용하기 때문에 데이터 뿐 아니라 데이터베이스 자체를 제거해도 된다. 

### 임베디드 모드 DB
- H2 는 자바로 개발되어 있고 JVM 안에서 메모르 모드로 동작할 수 있어 애플리케이션을 실행할 때 H2 도 해당 JVM 메모리에 포함해서 함께 실행할 수 있다. 
- DB 를 애플리케이션에 내장해서 함께 실행한다고 해서 임베디드 모드 (Embedded mode) 라고 한다. 
- 애플리케이션이 종료되면 임베디드 모드로 등작하는 H2 도 함께 종료된다. 

#### 사용 방법
1. 초기 테이블 생성을 위한 DDL 스크립트 작성 ( `src/test/resources/schema.sql` )
```sql
drop table if exists item CASCADE;  
create table item  
(  
    id        bigint generated by default as identity,  
    item_name varchar(10),  
    price     integer,  
    quantity  integer,  
    primary key (id)  
);
```
2. 애플리케이션 소스에 test profile 을 추가한다.
```java
public class ItemServiceApplication {  
  
    public static void main(String[] args) {  
       SpringApplication.run(ItemServiceApplication.class, args);  
    }  
  
    ..

    @Bean    
    @Profile("test")    
    public DataSource dataSource() {
		log.info("메모리 데이터베이스 초기화");  
        DriverManagerDataSource dataSource = new DriverManagerDataSource();
        dataSource.setDriverClassName("org.h2.Driver");       
        dataSource.setUrl("jdbc:h2:mem:db;DB_CLOSE_DELAY=-1");       
        dataSource.setUsername("sa");       
        dataSource.setPassword("");       
        return dataSource;    
	}
}
```

<br>

### 스프링 부트와 임베디드 모드
- 스프링 부트는 임베디드 데이터베이스에 대한 설정을 기본으로 제공한다. 
- 스프링 부트는 데이터베이스에 대한 별다른 설정이 없으면 임베디드 데이터베이스를 사용하기 때문에 앞서 작성했던 메모리 DB 용 데이터소스와 properties 설정 정보가 필요 없다.
```properties
## test 하위 application.properties

spring.profiles.active=test  
# spring.datasource.url=jdbc:h2:tcp://localhost/~/testcase  
# spring.datasource.username=sa
```

<br>

## 정리
- 결론적으로 테스트를 위해 개발자가 테이블 생성을 위한 DDL 스크립트 작성과 `@Transactional` 만 사용하면 스프링 부트가 임베디드 데이터베이스를 생성해주고 잔여 데이터에 대한 걱정을 없애준다는 것을 알 수 있다.  

<br>

## 참고 
[인프런 - 스프링 DB 2편 - 데이터 접근 활용 기술](https://inf.run/NMpER) 